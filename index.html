<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pano</title>
    <!-- A-Frame library -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; background:#000; }
        #app { position: fixed; inset: 0; width:100%; height:100%; display:block; touch-action:none; }
        #ui { position: fixed; left:0; right:0; bottom:0; padding:12px; display:grid; gap:8px;
            background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 18%, rgba(0,0,0,.7) 100%);
            color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
        #row { display:flex; align-items:center; gap:8px; flex-wrap: wrap; }
        button { appearance:none; border:0; border-radius:999px; padding:10px 14px; font-weight:600; background:#fff; color:#000; cursor:pointer; }
        button.secondary { background: rgba(255,255,255,.12); color:#fff; border:1px solid rgba(255,255,255,.25); }
        #status { font-size:12px; opacity:.85; line-height:1.3; }
        .chip { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); font-size:12px; }
        #navBtns { position: fixed; top: 12px; right: 12px; z-index: 20; display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
        #followBtn[data-on="true"] { background:#06f; color:#fff; }
        /* Loader overlay */
        #loader { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; flex-direction:column;
            background: rgba(0,0,0,.75); color:#fff; z-index:100; transition: opacity .3s ease; }
        #loader.hidden { opacity:0; pointer-events:none; }
        #progress { width:200px; height:8px; border-radius:999px; background:rgba(255,255,255,.2); overflow:hidden; margin-top:12px; }
        #progress div { height:100%; width:0%; background:#fff; transition: width .1s linear; }
    </style>
  </head>
  <body>
    <div id="app" style="margin-top:60px;"></div>

    <!-- A-Frame Scene -->
    <a-scene vr-mode-ui="enabled: false">
      <!-- Sky with panoramic image -->
      <a-sky id="sky" rotation="0 -130 0"></a-sky>
    </a-scene>

    <div id="loader">
        <div>Loading image…</div>
        <div id="progress"><div></div></div>
    </div>

    <div id="navBtns">
      <button id="btnZoomIn" title="Zoom in">＋</button>
      <button id="btnZoomOut" title="Zoom out">－</button>
      <button id="btnResetRot" title="Reset view">⟳</button>
      <button class="img-btn" data-idx="0">Image 1</button>
      <button class="img-btn" data-idx="1">Image 2</button>
      <button class="img-btn" data-idx="2">Image 3</button>
      <!-- <button class="img-btn" data-idx="3">Image 4</button> -->
    </div>

    <script>
      const images = ["./public/lantis-1.jpg", "./public/lantis-2.jpg", "./public/lantis-3.jpg", "./public/ar.png"];
      let currentIndex = 0;
      const sky = document.getElementById("sky");
      const loader = document.getElementById("loader");
      const progressBar = document.querySelector("#progress div");
      // Remove next/prev logic, use dedicated image buttons
      const btnZoomIn = document.getElementById("btnZoomIn");
      const btnZoomOut = document.getElementById("btnZoomOut");
      const btnResetRot = document.getElementById("btnResetRot");
      // Reset rotation logic
      btnResetRot.onclick = () => {
        const scene = document.querySelector('a-scene');
        if (scene && scene.camera) {
          scene.camera.rotation.set(0, 0, 0);
          scene.camera.updateProjectionMatrix();
        }
        // Also reset look-controls if present
        const camEl = scene.querySelector('[camera]');
        if (camEl && camEl.components["look-controls"]) {
          camEl.components["look-controls"].pitchObject.rotation.x = 0;
          camEl.components["look-controls"].yawObject.rotation.y = 0;
        }
      };

      // Camera zoom logic
      let fov = 80; // Default A-Frame camera fov
      const minFov = 30;
      const maxFov = 120;
      function setCameraFov(newFov) {
        fov = Math.max(minFov, Math.min(maxFov, newFov));
        const camera = document.querySelector('a-scene').camera;
        if (camera) camera.fov = fov;
        if (camera) camera.updateProjectionMatrix();
      }
      btnZoomIn.onclick = () => {
        setCameraFov(fov - 10);
      };
      btnZoomOut.onclick = () => {
        setCameraFov(fov + 10);
      };
      // Set initial fov
      window.addEventListener('DOMContentLoaded', () => setTimeout(() => setCameraFov(fov), 500));

      function showLoader() {
        progressBar.style.width = "0%";
        loader.classList.remove("hidden");
      }
      function updateLoader(percent) {
        progressBar.style.width = percent + "%";
      }
      function hideLoader() {
        loader.classList.add("hidden");
      }

      function loadSkyImage(idx) {
        showLoader();
        const xhr = new XMLHttpRequest();
        xhr.open('GET', images[idx], true);
        xhr.responseType = 'blob';
        xhr.onprogress = function(e) {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            updateLoader(percent);
          }
        };
        xhr.onload = function() {
          if (xhr.status === 200) {
            updateLoader(100);
            const blob = xhr.response;
            const reader = new FileReader();
            reader.onloadend = function() {
              sky.setAttribute('src', reader.result);
              setTimeout(hideLoader, 300);
            };
            reader.readAsDataURL(blob);
          } else {
            hideLoader();
            alert('Failed to load image.');
          }
        };
        xhr.onerror = function() {
          hideLoader();
          alert('Failed to load image.');
        };
        xhr.send();
      }

      function showImage(idx) {
        currentIndex = idx;
        loadSkyImage(idx);
        // Highlight active button
        document.querySelectorAll('.img-btn').forEach((btn, i) => {
          btn.classList.toggle('secondary', i !== idx);
        });
      }

      document.querySelectorAll('.img-btn').forEach(btn => {
        btn.onclick = () => {
          const idx = parseInt(btn.getAttribute('data-idx'), 10);
          showImage(idx);
        };
      });

      // Initial load
      showImage(currentIndex);
    </script>
  </body>
</html>
